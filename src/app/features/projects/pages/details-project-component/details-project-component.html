<!-- ═══════════════════════════════════════════════════════════════════
     PROJECT DETAILS — Refined Editorial Dark Theme
     ═══════════════════════════════════════════════════════════════════ -->

<div class="relative max-w-7xl mx-auto px-6 py-8 space-y-10">

    <!-- ── Ambient Background Glow ── -->
    <div class="fixed top-0 left-64 right-0 h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute -top-[10%] left-[20%] w-[500px] h-[500px] rounded-full blur-[160px] bg-indigo-600/[0.04]">
        </div>
        <div
            class="absolute bottom-[20%] right-[10%] w-[400px] h-[400px] rounded-full blur-[140px] bg-purple-600/[0.03]">
        </div>
    </div>

    <!-- ── Top Navigation ── -->
    <div class="det-entrance flex items-center justify-between">
        <button routerLink="/home/projects"
            class="group flex items-center gap-2 px-4 py-2 bg-white/[0.02] hover:bg-white/[0.06] border border-white/[0.06] rounded-xl text-[11px] font-bold uppercase tracking-widest text-neutral-500 hover:text-white transition-all">
            <iconify-icon icon="lucide:arrow-left" width="14"
                class="transition-transform group-hover:-translate-x-1"></iconify-icon>
            Volver a Proyectos
        </button>

        @if (proyect()) {
        <div class="px-4 py-2 bg-white/[0.03] border border-white/[0.06] rounded-xl">
            <span class="text-[11px] font-medium text-neutral-400 flex items-center gap-2">
                <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full det-glow-dot"></span>
                Proyecto #{{ proyect()!.id_proyecto }}
            </span>
        </div>
        }
    </div>

    @if (proyect()) {
    <!-- ═══════════════════════ PROJECT HEADER ═══════════════════════ -->
    <div class="det-entrance det-entrance-delay-1 space-y-6">
        <div
            class="relative bg-white/[0.015] border border-white/[0.06] rounded-3xl overflow-hidden det-grain p-8 md:p-10">
            <div class="relative z-10 grid grid-cols-1 lg:grid-cols-3 gap-10">

                <!-- Left: Main Info -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="space-y-4">
                        <div class="flex items-center gap-3">
                            <span
                                [class]="'px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-widest border ' + getStatusColor()">
                                {{ proyect()!.estado | titlecase }}
                            </span>
                            <span
                                [class]="'px-3 py-1 rounded-lg text-[10px] font-bold uppercase tracking-widest border ' + getPriorityColor()">
                                Prioridad {{ proyect()!.prioridad | titlecase }}
                            </span>
                        </div>
                        <h1 class="det-display-font text-3xl md:text-4xl font-extrabold text-white leading-tight">
                            {{ proyect()!.nombre }}
                        </h1>
                        <p class="text-[15px] text-neutral-400 leading-relaxed max-w-2xl">
                            {{ proyect()!.descripcion || 'Sin descripción detallada disponible para este proyecto.' }}
                        </p>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Client -->
                        <div class="p-5 bg-white/[0.02] border border-white/[0.04] rounded-2xl flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-xl bg-indigo-500/10 border border-indigo-500/15 flex items-center justify-center text-indigo-400 shadow-inner">
                                <iconify-icon icon="lucide:building-2" width="22"></iconify-icon>
                            </div>
                            <div>
                                <p class="text-[9px] font-bold uppercase tracking-[0.15em] text-neutral-600 mb-0.5">
                                    Cliente Asignado</p>
                                <p class="text-[14px] text-white font-semibold leading-none">{{
                                    proyect()?.cliente?.nombres }} {{ proyect()?.cliente?.apellidos }}</p>
                            </div>
                        </div>

                        <!-- Content Quantity -->
                        <div class="p-5 bg-white/[0.02] border border-white/[0.04] rounded-2xl flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-xl bg-emerald-500/10 border border-emerald-500/15 flex items-center justify-center text-emerald-400 shadow-inner">
                                <iconify-icon icon="lucide:package-2" width="22"></iconify-icon>
                            </div>
                            <div>
                                <p class="text-[9px] font-bold uppercase tracking-[0.15em] text-neutral-600 mb-0.5">
                                    Cantidad Contenido</p>
                                <p class="text-[14px] text-white font-semibold leading-none">{{
                                    proyect()!.cantidad_material }} Unidades</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Status / Timeline -->
                <div class="space-y-4">
                    <!-- Summary Stats -->
                    <div class="p-6 bg-white/[0.02] border border-white/[0.04] rounded-2xl space-y-5">
                        <div class="space-y-1.5">
                            <div class="flex justify-between items-end">
                                <span class="text-[10px] font-bold uppercase tracking-widest text-neutral-600">Timeline
                                    Global</span>
                                <span class="text-[14px] font-bold text-indigo-400 tabular-nums">{{ calculateDuration()
                                    }} días</span>
                            </div>
                            <!-- Mini timeline visualization -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p class="text-[9px] font-bold uppercase tracking-widest text-neutral-600 mb-1">
                                        Inicio</p>
                                    <p class="text-[12px] text-neutral-300 font-medium">{{ proyect()!.fecha_registro |
                                        date:'dd MMM, yyyy' }}</p>
                                </div>
                                <div>
                                    <p class="text-[9px] font-bold uppercase tracking-widest text-neutral-600 mb-1">Fin
                                        Estimado</p>
                                    <p class="text-[12px] text-neutral-300 font-medium">{{ proyect()!.fecha_termino |
                                        date:'dd MMM, yyyy' }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-white/[0.04] space-y-3">
                            <p class="text-[10px] font-bold uppercase tracking-widest text-neutral-600">Recursos</p>
                            @if (proyect()!.plan_grabacion_url) {
                            <a [href]="proyect()!.plan_grabacion_url" target="_blank"
                                class="group flex items-center justify-between p-3 bg-indigo-500/5 hover:bg-indigo-500/10 border border-indigo-500/10 rounded-xl transition-all">
                                <div class="flex items-center gap-3">
                                    <iconify-icon icon="lucide:file-text" width="18"
                                        class="text-indigo-400"></iconify-icon>
                                    <span class="text-[12px] text-neutral-300 font-medium">Plan de Grabación</span>
                                </div>
                                <iconify-icon icon="lucide:external-link" width="14"
                                    class="text-neutral-600 group-hover:text-indigo-400 transition-colors"></iconify-icon>
                            </a>
                            } @else {
                            <div
                                class="p-3 bg-white/[0.02] border border-white/5 rounded-xl flex items-center gap-3 opacity-50">
                                <iconify-icon icon="lucide:file-x-2" width="18" class="text-neutral-500"></iconify-icon>
                                <span class="text-[12px] text-neutral-500 italic">Sin plan adjunto</span>
                            </div>
                            }
                        </div>
                    </div>

                    <button
                        class="w-full py-3 bg-white/[0.03] hover:bg-white/[0.08] border border-white/10 text-white rounded-xl text-[11px] font-bold uppercase tracking-[0.2em] transition-all flex items-center justify-center gap-3 shadow-lg shadow-black/20">
                        <iconify-icon icon="lucide:edit-3" width="16"></iconify-icon>
                        Editar Proyecto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════ FOLDERS SECTION ═══════════════════════ -->
    <div class="det-entrance det-entrance-delay-2 space-y-8">
        <div class="flex flex-col md:flex-row md:items-end justify-between gap-6">
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                        <iconify-icon icon="lucide:folder" width="18"></iconify-icon>
                    </div>
                    <h2 class="det-display-font text-xl font-bold text-white tracking-tight">Carpetas del Proyecto</h2>
                </div>
                <p class="text-sm text-neutral-500">Documentación y material audiovisual organizado por categorías.</p>
            </div>

            <hlm-alert-dialog>
                <button hlmAlertDialogTrigger (click)="resetFolderForm()"
                    class="px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-semibold text-sm shadow-lg shadow-indigo-600/20 transition-all flex items-center gap-2">
                    <iconify-icon icon="lucide:folder-plus" width="16"></iconify-icon>
                    Nueva Carpeta
                </button>

                <hlm-alert-dialog-content class="sm:max-w-[500px] bg-[#0c0d14] border-white/10 p-0 overflow-hidden"
                    *brnAlertDialogContent="let ctx">
                    <div class="px-6 py-5 border-b border-white/[0.06] flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-9 h-9 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                                <iconify-icon [icon]="selectedFolder() ? 'lucide:edit-3' : 'lucide:folder-plus'"
                                    width="18"></iconify-icon>
                            </div>
                            <div>
                                <h3 class="det-display-font text-base font-bold text-white">{{ selectedFolder() ?
                                    'Editar Carpeta' : 'Crear Carpeta' }}</h3>
                                <p class="text-[10px] text-neutral-600 uppercase tracking-widest mt-0.5">Organización de
                                    material</p>
                            </div>
                        </div>
                        <button (click)="ctx.close(); resetFolderForm()"
                            class="text-neutral-500 hover:text-white transition-colors">
                            <iconify-icon icon="lucide:x" width="20"></iconify-icon>
                        </button>
                    </div>

                    <form [formGroup]="folderForm" (ngSubmit)="onSubmitFolder(ctx)" class="p-6 space-y-5">
                        <div class="space-y-1.5">
                            <label
                                class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-500 ml-1">Nombre
                                de la Carpeta *</label>
                            <input formControlName="nombre" type="text"
                                placeholder="Ej: Storyboards, Referencias, Brutos..."
                                class="w-full px-4 py-2.5 bg-white/[0.03] border border-white/[0.08] rounded-xl text-sm text-neutral-200 placeholder:text-neutral-700 focus:ring-1 focus:ring-indigo-500/30 focus:border-indigo-500/30 transition-all outline-none" />
                            @if (folderForm.get('nombre')?.touched && folderForm.get('nombre')?.invalid) {
                            <p class="text-[10px] text-red-400/80 italic ml-1">El nombre debe tener al menos 3
                                caracteres.</p>
                            }
                        </div>

                        <div class="space-y-1.5">
                            <label
                                class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-500 ml-1">Descripción
                                (Opcional)</label>
                            <textarea formControlName="descripcion"
                                placeholder="¿Qué tipo de archivos contendrá esta carpeta?"
                                class="w-full px-4 py-2.5 bg-white/[0.03] border border-white/[0.08] rounded-xl text-sm text-neutral-200 placeholder:text-neutral-700 focus:ring-1 focus:ring-indigo-500/30 focus:border-indigo-500/30 transition-all outline-none resize-none min-h-[100px]"></textarea>
                        </div>
                    </form>

                    <div class="px-6 py-4 border-t border-white/[0.06] flex items-center justify-end gap-3">
                        <button (click)="ctx.close(); resetFolderForm()"
                            class="px-4 py-2 text-sm font-medium text-neutral-500 hover:text-white transition-colors">Cancelar</button>
                        <button (click)="onSubmitFolder(ctx)" [disabled]="folderForm.invalid"
                            class="px-5 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:bg-neutral-800 disabled:text-neutral-600 text-white rounded-xl font-semibold text-sm shadow-lg shadow-indigo-600/15 transition-all">
                            {{ selectedFolder() ? 'Guardar Cambios' : 'Crear Carpeta' }}
                        </button>
                    </div>
                </hlm-alert-dialog-content>
            </hlm-alert-dialog>
        </div>

        <!-- Folders Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
            @if (projectFolders().length > 0) {
            @for (folder of projectFolders(); track folder.id_carpeta_material) {
            <div
                class="folder-card group relative bg-white/[0.012] border border-white/[0.06] rounded-2xl overflow-hidden det-grain flex flex-col p-6">

                <div class="flex items-start justify-between mb-8">
                    <div class="flex items-center gap-4">
                        <div
                            [class]="'w-14 h-14 rounded-2xl bg-indigo-500/10 border border-indigo-500/20 flex items-center justify-center text-indigo-400 shadow-lg group-hover:scale-110 transition-transform duration-500'">
                            <iconify-icon [icon]="folder.icono || 'lucide:folder'" width="28"></iconify-icon>
                        </div>
                        <div class="space-y-0.5">
                            <h3
                                class="det-display-font text-base font-bold text-white group-hover:text-indigo-400 transition-colors line-clamp-1">
                                {{ folder.nombre }}
                            </h3>
                            <p class="text-[11px] text-neutral-600 uppercase tracking-wider font-bold">
                                {{ folder.proyecto_material?.length || 0 }} Archivos
                            </p>
                        </div>
                    </div>

                    <!-- Dropdown Menu -->
                    <button [hlmDropdownMenuTrigger]="folderMenu"
                        class="p-2 bg-white/[0.03] hover:bg-white/[0.08] border border-white/5 text-neutral-600 hover:text-white rounded-lg transition-all opacity-0 group-hover:opacity-100">
                        <iconify-icon icon="lucide:more-vertical" width="16"></iconify-icon>
                    </button>

                    <ng-template #folderMenu>
                        <hlm-dropdown-menu
                            class="w-48 bg-neutral-950 border-white/10 rounded-xl overflow-hidden shadow-2xl">
                            <hlm-alert-dialog>
                                <button hlmDropdownMenuItem hlmAlertDialogTrigger (click)="editFolder(folder)"
                                    class="w-full flex items-center gap-2 hover:bg-white/5 py-2.5">
                                    <iconify-icon icon="lucide:edit-2" width="14" class="text-amber-400"></iconify-icon>
                                    <span class="text-[12px] text-neutral-300">Renombrar</span>
                                </button>

                                <!-- Reutilizamos el modal content de edición -->
                                <hlm-alert-dialog-content
                                    class="sm:max-w-[500px] bg-[#0c0d14] border-white/10 p-0 overflow-hidden"
                                    *brnAlertDialogContent="let ctx">
                                    <div
                                        class="px-6 py-5 border-b border-white/[0.06] flex items-center justify-between">
                                        <h3 class="det-display-font text-base font-bold text-white text-emerald-500">
                                            Editar Carpeta</h3>
                                        <button (click)="ctx.close(); resetFolderForm()"
                                            class="text-neutral-500 hover:text-white"><iconify-icon icon="lucide:x"
                                                width="20"></iconify-icon></button>
                                    </div>
                                    <form [formGroup]="folderForm" (ngSubmit)="onSubmitFolder(ctx)" class="p-6">
                                        <input hlmInput formControlName="nombre"
                                            class="w-full bg-white/[0.03] border-white/[0.08] rounded-xl text-sm" />
                                    </form>
                                    <div class="px-6 py-4 border-t border-white/[0.06] flex justify-end gap-3">
                                        <button (click)="ctx.close()" class="text-sm text-neutral-500">Cancelar</button>
                                        <button (click)="onSubmitFolder(ctx)"
                                            class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-bold">Guardar</button>
                                    </div>
                                </hlm-alert-dialog-content>
                            </hlm-alert-dialog>

                            <button hlmDropdownMenuItem
                                class="w-full flex items-center gap-2 hover:bg-white/5 py-2.5 group">
                                <iconify-icon icon="lucide:share-2" width="14" class="text-blue-400"></iconify-icon>
                                <span class="text-[12px] text-neutral-300">Compartir</span>
                            </button>

                            <hlm-dropdown-menu-separator class="bg-white/5"></hlm-dropdown-menu-separator>

                            <button hlmDropdownMenuItem (click)="deleteFolder(folder.id_carpeta_material!)"
                                class="w-full flex items-center gap-2 hover:bg-red-500/10 py-2.5 group">
                                <iconify-icon icon="lucide:trash-2" width="14" class="text-red-400"></iconify-icon>
                                <span class="text-[12px] text-red-400">Eliminar Carpeta</span>
                            </button>
                        </hlm-dropdown-menu>
                    </ng-template>
                </div>

                <p class="text-[13px] text-neutral-500 leading-relaxed line-clamp-2 min-h-[3rem] mb-6">
                    {{ folder.descripcion || 'Sin descripción adicional para esta categoría.' }}
                </p>

                <div class="mt-auto pt-5 border-t border-white/[0.04]">
                    <button hlmBtn variant="outline"
                        [routerLink]="'/home/projects/' + proyect()!.id_proyecto + '/folder/' + folder.id_carpeta_material"
                        class="w-full border-white/10 text-neutral-400 hover:text-white hover:bg-indigo-600 hover:border-indigo-600 font-bold uppercase tracking-widest text-[10px] h-11 rounded-xl transition-all flex items-center justify-center gap-3">
                        Ver Contenido
                        <iconify-icon icon="lucide:arrow-right" width="14"></iconify-icon>
                    </button>
                </div>
            </div>
            }
            } @else {
            <div
                class="col-span-full py-24 flex flex-col items-center gap-6 rounded-3xl bg-white/[0.015] border border-dashed border-white/10 det-grain">
                <div
                    class="w-20 h-20 rounded-3xl bg-white/[0.02] border border-white/5 flex items-center justify-center">
                    <iconify-icon icon="lucide:folder-search" width="40" class="text-neutral-700"></iconify-icon>
                </div>
                <div class="text-center space-y-1.5">
                    <h3 class="det-display-font text-lg font-bold text-neutral-400">Sin carpetas creadas</h3>
                    <p class="text-sm text-neutral-600 max-w-xs leading-relaxed">Comienza a organizar la documentación
                        del proyecto creando tu primera categoría de archivos.</p>
                </div>
                <button (click)="resetFolderForm()"
                    class="px-6 py-2.5 bg-indigo-600/10 hover:bg-indigo-600/20 text-indigo-400 rounded-xl text-xs font-bold uppercase tracking-widest border border-indigo-600/20 transition-all">
                    Crear mi primera carpeta
                </button>
            </div>
            }
        </div>
    </div>
    } @else {
    <!-- Loading State -->
    <div class="flex flex-col items-center justify-center min-h-[60vh] gap-6">
        <div class="relative">
            <div class="w-16 h-16 rounded-full border-4 border-indigo-500/10 border-t-indigo-500 animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center">
                <iconify-icon icon="lucide:loader" width="24" class="text-indigo-400"></iconify-icon>
            </div>
        </div>
        <p class="det-display-font text-sm font-bold text-neutral-500 uppercase tracking-widest animate-pulse">Cargando
            Proyecto...</p>
    </div>
    }
</div>

<hlm-toaster />