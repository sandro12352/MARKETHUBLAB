<!-- ═══════════════════════════════════════════════════════════════════
     TASK MODULE — Refined Editorial Dark Theme
     Admin: ve todas las tareas, crea/asigna, aprueba/rechaza
     Worker: ve solo sus tareas, marca como subida
     ═══════════════════════════════════════════════════════════════════ -->

<div class="relative max-w-7xl mx-auto px-6 py-8 space-y-10">

    <!-- ── Ambient Background Glow ── -->
    <div class="fixed top-0 left-64 right-0 h-full overflow-hidden -z-10 pointer-events-none">
        <div class="absolute -top-[30%] left-[10%] w-[500px] h-[500px] rounded-full blur-[160px] bg-indigo-600/[0.07]">
        </div>
        <div class="absolute top-[50%] right-[5%] w-[400px] h-[400px] rounded-full blur-[140px] bg-violet-600/[0.04]">
        </div>
    </div>

    <!-- ═══════════════════════ HEADER ═══════════════════════ -->
    <div class="task-entrance flex flex-col md:flex-row md:items-end justify-between gap-6">
        <div class="space-y-2">
            <div class="flex items-center gap-3 mb-1">
                <div
                    class="w-10 h-10 rounded-xl bg-indigo-500/10 border border-indigo-500/15 flex items-center justify-center text-indigo-400">
                    <iconify-icon icon="lucide:list-checks" width="20"></iconify-icon>
                </div>
                <div>
                    <p class="text-[10px] font-semibold uppercase tracking-[0.2em] text-neutral-500">Módulo</p>
                    <h1 class="task-display-font text-2xl font-bold text-white leading-tight">
                        Gestión de Tareas
                    </h1>
                </div>
            </div>
            <p class="text-sm text-neutral-500 max-w-md leading-relaxed pl-[52px]">
                @if (isAdmin()) {
                Administra, asigna y supervisa las tareas de todo el equipo.
                } @else {
                Revisa y gestiona las tareas que te han sido asignadas.
                }
            </p>
        </div>

        <div class="flex items-center gap-3">
            @if (isAdmin()) {
            <button (click)="openCreateModal()"
                class="task-action-btn px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-semibold text-sm shadow-lg shadow-indigo-600/20 transition-all flex items-center gap-2">
                <iconify-icon icon="lucide:plus" width="16"></iconify-icon>
                Nueva Tarea
            </button>
            }
            <div class="px-4 py-2 bg-white/[0.03] border border-white/[0.06] rounded-xl">
                <span class="text-[11px] font-medium text-neutral-400 flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-indigo-400 rounded-full task-glow-dot"></span>
                    @if (isAdmin()) { Administrador } @else { Trabajador }
                </span>
            </div>
        </div>
    </div>

    <!-- ═══════════════════════ STATS ROW ═══════════════════════ -->
    <div class="task-entrance task-entrance-delay-1 grid grid-cols-2 lg:grid-cols-5 gap-3">

        <!-- Pendientes -->
        <button (click)="setFilter('pendiente')" [class]="'stat-card stat-card-pending task-grain relative p-5 rounded-2xl border text-left cursor-pointer ' +
        (activeFilter() === 'pendiente'
          ? 'bg-amber-500/[0.06] border-amber-500/20'
          : 'bg-white/[0.02] border-white/[0.06] hover:border-amber-500/15')">
            <div class="relative z-10">
                <div class="w-9 h-9 rounded-xl bg-amber-500/10 flex items-center justify-center text-amber-400 mb-3">
                    <iconify-icon icon="lucide:clock" width="18"></iconify-icon>
                </div>
                <p class="task-display-font text-2xl font-bold text-white">{{ pendingCount() }}</p>
                <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-neutral-500 mt-1">Pendientes</p>
            </div>
        </button>

        <!-- En Progreso -->
        <button (click)="setFilter('en_progreso')" [class]="'stat-card stat-card-progress task-grain relative p-5 rounded-2xl border text-left cursor-pointer ' +
        (activeFilter() === 'en_progreso'
          ? 'bg-blue-500/[0.06] border-blue-500/20'
          : 'bg-white/[0.02] border-white/[0.06] hover:border-blue-500/15')">
            <div class="relative z-10">
                <div class="w-9 h-9 rounded-xl bg-blue-500/10 flex items-center justify-center text-blue-400 mb-3">
                    <iconify-icon icon="lucide:activity" width="18"></iconify-icon>
                </div>
                <p class="task-display-font text-2xl font-bold text-white">{{ inProgressCount() }}</p>
                <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-neutral-500 mt-1">En Progreso</p>
            </div>
        </button>

        <!-- Subidos -->
        <button (click)="setFilter('subido')" [class]="'stat-card stat-card-uploaded task-grain relative p-5 rounded-2xl border text-left cursor-pointer ' +
        (activeFilter() === 'subido'
          ? 'bg-purple-500/[0.06] border-purple-500/20'
          : 'bg-white/[0.02] border-white/[0.06] hover:border-purple-500/15')">
            <div class="relative z-10">
                <div class="w-9 h-9 rounded-xl bg-purple-500/10 flex items-center justify-center text-purple-400 mb-3">
                    <iconify-icon icon="lucide:upload-cloud" width="18"></iconify-icon>
                </div>
                <p class="task-display-font text-2xl font-bold text-white">{{ uploadedCount() }}</p>
                <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-neutral-500 mt-1">Subidos</p>
            </div>
        </button>

        <!-- Aprobados -->
        <button (click)="setFilter('aprobado')" [class]="'stat-card stat-card-approved task-grain relative p-5 rounded-2xl border text-left cursor-pointer ' +
        (activeFilter() === 'aprobado'
          ? 'bg-emerald-500/[0.06] border-emerald-500/20'
          : 'bg-white/[0.02] border-white/[0.06] hover:border-emerald-500/15')">
            <div class="relative z-10">
                <div
                    class="w-9 h-9 rounded-xl bg-emerald-500/10 flex items-center justify-center text-emerald-400 mb-3">
                    <iconify-icon icon="lucide:check-circle-2" width="18"></iconify-icon>
                </div>
                <p class="task-display-font text-2xl font-bold text-white">{{ approvedCount() }}</p>
                <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-neutral-500 mt-1">Aprobados</p>
            </div>
        </button>

        <!-- Rechazados -->
        <button (click)="setFilter('rechazado')" [class]="'stat-card stat-card-rejected task-grain relative p-5 rounded-2xl border text-left cursor-pointer ' +
        (activeFilter() === 'rechazado'
          ? 'bg-red-500/[0.06] border-red-500/20'
          : 'bg-white/[0.02] border-white/[0.06] hover:border-red-500/15')">
            <div class="relative z-10">
                <div class="w-9 h-9 rounded-xl bg-red-500/10 flex items-center justify-center text-red-400 mb-3">
                    <iconify-icon icon="lucide:x-circle" width="18"></iconify-icon>
                </div>
                <p class="task-display-font text-2xl font-bold text-white">{{ rejectedCount() }}</p>
                <p class="text-[10px] font-semibold uppercase tracking-[0.15em] text-neutral-500 mt-1">Rechazados</p>
            </div>
        </button>
    </div>

    <!-- ═══════════════════════ TOOLBAR ═══════════════════════ -->
    <div class="task-entrance task-entrance-delay-2 flex flex-col md:flex-row items-stretch md:items-center gap-3">
        <!-- Search -->
        <div class="relative flex-1">
            <iconify-icon icon="lucide:search" class="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-600"
                width="16"></iconify-icon>
            <input type="text" placeholder="Buscar por nombre, descripción o trabajador..."
                (input)="onSearchChange($event)"
                class="w-full pl-11 pr-4 py-2.5 bg-white/[0.02] border border-white/[0.06] rounded-xl text-sm text-neutral-300 placeholder:text-neutral-600 focus:ring-1 focus:ring-indigo-500/30 focus:border-indigo-500/30 transition-all outline-none" />
        </div>

        <!-- Filter Pills -->
        <div class="flex items-center gap-2 flex-shrink-0">
            <button (click)="setFilter('todas')"
                [class]="'px-4 py-2.5 rounded-xl text-[11px] font-semibold uppercase tracking-wider transition-all ' +
          (activeFilter() === 'todas'
            ? 'bg-indigo-600 text-white shadow-md shadow-indigo-600/15'
            : 'bg-white/[0.02] text-neutral-500 border border-white/[0.06] hover:border-white/10 hover:text-neutral-300')">
                Todas
            </button>
            <button (click)="loadData()"
                class="task-action-btn p-2.5 bg-white/[0.02] border border-white/[0.06] text-neutral-500 rounded-xl hover:text-white hover:border-white/10 transition-all"
                title="Refrescar">
                <iconify-icon icon="lucide:refresh-cw" width="14"></iconify-icon>
            </button>
        </div>
    </div>

    <!-- ═══════════════════════ TASK LIST ═══════════════════════ -->
    <div
        class="task-entrance task-entrance-delay-3 bg-white/[0.015] border border-white/[0.06] rounded-2xl overflow-hidden task-grain relative">
        <!-- Table Header -->
        <div class="relative z-10 px-6 py-4 border-b border-white/[0.06] flex items-center justify-between">
            <h3 class="task-display-font text-sm font-semibold text-neutral-200 flex items-center gap-2.5">
                <iconify-icon icon="lucide:layers" class="text-indigo-400" width="16"></iconify-icon>
                Tareas
            </h3>
            <span class="text-[11px] text-neutral-600 font-medium tabular-nums">
                {{ filteredTasks().length }} / {{ tasks().length }}
            </span>
        </div>

        <div class="relative z-10 overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="border-b border-white/[0.04]">
                        <th
                            class="px-6 py-3 text-left text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600">
                            Tarea</th>
                        @if (isAdmin()) {
                        <th
                            class="px-6 py-3 text-left text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600">
                            Asignado</th>
                        }
                        <th
                            class="px-6 py-3 text-left text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600">
                            Prioridad</th>
                        <th
                            class="px-6 py-3 text-left text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600">
                            Fecha Lím.</th>
                        <th
                            class="px-6 py-3 text-center text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600">
                            Estado</th>
                        <th
                            class="px-6 py-3 text-right text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600">
                            Acciones</th>
                    </tr>
                </thead>
                <tbody>

                    <!-- ── Loading Skeletons ── -->
                    @if (loading()) {
                    @for (i of [1,2,3,4]; track i) {
                    <tr>
                        <td class="px-6 py-5">
                            <div class="task-skeleton h-4 w-36"></div>
                            <div class="task-skeleton h-3 w-48 mt-2"></div>
                        </td>
                        @if (isAdmin()) { <td class="px-6 py-5">
                            <div class="task-skeleton h-4 w-28"></div>
                        </td> }
                        <td class="px-6 py-5">
                            <div class="task-skeleton h-4 w-14"></div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="task-skeleton h-4 w-20"></div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="task-skeleton h-5 w-20 mx-auto"></div>
                        </td>
                        <td class="px-6 py-5">
                            <div class="task-skeleton h-4 w-20 ml-auto"></div>
                        </td>
                    </tr>
                    }

                    } @else {

                    @for (task of filteredTasks(); track task.id_cliente_tarea) {
                    <tr class="task-status-border group border-b border-white/[0.03] last:border-b-0 hover:bg-white/[0.02] transition-colors"
                        [ngClass]="'task-status-' + task.estado">

                        <!-- Tarea -->
                        <td class="px-6 py-4 pl-8">
                            <button (click)="openDetailModal(task)" class="text-left group/name">
                                <p
                                    class="text-[13px] font-medium text-neutral-200 group-hover/name:text-indigo-400 transition-colors leading-tight">
                                    {{ task.nombre }}
                                </p>
                                <p class="text-[11px] text-neutral-600 mt-1 line-clamp-1 max-w-[220px]">{{
                                    task.descripcion }}</p>
                            </button>
                        </td>

                        <!-- Asignado (admin) -->
                        @if (isAdmin()) {
                        <td class="px-6 py-4">
                            <div class="flex items-center gap-2.5">
                                <div
                                    class="w-7 h-7 rounded-lg bg-gradient-to-br from-indigo-500/80 to-violet-600/80 flex items-center justify-center text-white text-[10px] font-bold shadow-sm shadow-indigo-500/10">
                                    {{ task.trabajador?.nombres?.charAt(0) }}{{ task.trabajador?.apellidos?.charAt(0) }}
                                </div>
                                <div>
                                    <p class="text-[12px] text-neutral-300 font-medium leading-tight">{{
                                        task.trabajador?.nombres }} {{ task.trabajador?.apellidos }}</p>
                                    <p class="text-[10px] text-neutral-600">#{{ task.trabajador?.id_trabajador }}</p>
                                </div>
                            </div>
                        </td>
                        }

                        <!-- Prioridad -->
                        <td class="px-6 py-4">
                            <span
                                [class]="'inline-flex items-center gap-1.5 text-[11px] font-semibold ' +
                    (task.prioridad === 'alta' ? 'text-red-400' : task.prioridad === 'media' ? 'text-amber-400' : 'text-emerald-400')">
                                <iconify-icon [icon]="getPriorityIcon(task.prioridad)" width="13"></iconify-icon>
                                {{ getPriorityLabel(task.prioridad) }}
                            </span>
                        </td>

                        <!-- Fecha Límite -->
                        <td class="px-6 py-4">
                            @if (task.fecha_limite) {
                            <span class="text-[12px] text-neutral-400 flex items-center gap-1.5">
                                <iconify-icon icon="lucide:calendar" width="12" class="text-neutral-600"></iconify-icon>
                                {{ task.fecha_limite | date:'dd MMM yyyy' }}
                            </span>
                            } @else {
                            <span class="text-[11px] text-neutral-700 italic">—</span>
                            }
                        </td>

                        <!-- Estado Badge -->
                        <td class="px-6 py-4 text-center">
                            <span [class]="'inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider ' +
                    (task.estado === 'pendiente' ? 'bg-amber-500/8 text-amber-400 border border-amber-500/15' :
                     task.estado === 'en_progreso' ? 'bg-blue-500/8 text-blue-400 border border-blue-500/15' :
                     task.estado === 'subido' ? 'bg-purple-500/8 text-purple-400 border border-purple-500/15' :
                     task.estado === 'aprobado' ? 'bg-emerald-500/8 text-emerald-400 border border-emerald-500/15' :
                     'bg-red-500/8 text-red-400 border border-red-500/15')">
                                <span [class]="'w-1 h-1 rounded-full ' +
                      (task.estado === 'pendiente' ? 'bg-amber-400' :
                       task.estado === 'en_progreso' ? 'bg-blue-400' :
                       task.estado === 'subido' ? 'bg-purple-400' :
                       task.estado === 'aprobado' ? 'bg-emerald-400' :
                       'bg-red-400')"></span>
                                {{ getStatusLabel(task.estado) }}
                            </span>
                        </td>

                        <!-- Acciones -->
                        <td class="px-6 py-4 text-right">
                            <div
                                class="flex items-center justify-end gap-1.5 opacity-40 group-hover:opacity-100 transition-opacity">
                                <!-- Ver detalle -->
                                <button (click)="openDetailModal(task)"
                                    class="task-action-btn p-2 rounded-lg text-neutral-500 hover:text-indigo-400 hover:bg-indigo-500/10 transition-all"
                                    title="Ver detalle">
                                    <iconify-icon icon="lucide:eye" width="15"></iconify-icon>
                                </button>

                                @if (isAdmin()) {
                                @if (task.estado === 'subido') {
                                <button (click)="approveTask(task.id_cliente_tarea)"
                                    class="task-action-btn p-2 rounded-lg text-emerald-500 hover:bg-emerald-500/10 transition-all"
                                    title="Aprobar">
                                    <iconify-icon icon="lucide:check" width="15"></iconify-icon>
                                </button>
                                <button (click)="openRejectModal(task.id_cliente_tarea)"
                                    class="task-action-btn p-2 rounded-lg text-red-500 hover:bg-red-500/10 transition-all"
                                    title="Rechazar">
                                    <iconify-icon icon="lucide:x" width="15"></iconify-icon>
                                </button>
                                }
                                <button (click)="deleteTask(task.id_cliente_tarea)"
                                    class="task-action-btn p-2 rounded-lg text-neutral-600 hover:text-red-400 hover:bg-red-500/10 transition-all"
                                    title="Eliminar">
                                    <iconify-icon icon="lucide:trash-2" width="15"></iconify-icon>
                                </button>
                                } @else {
                                @if (task.estado === 'pendiente' || task.estado === 'en_progreso') {
                                <button (click)="markAsUploaded(task.id_cliente_tarea)"
                                    class="task-action-btn p-2 rounded-lg text-purple-500 hover:bg-purple-500/10 transition-all"
                                    title="Marcar como completada">
                                    <iconify-icon icon="lucide:upload-cloud" width="15"></iconify-icon>
                                </button>
                                }
                                }
                            </div>
                        </td>
                    </tr>
                    } @empty {
                    <tr>
                        <td [attr.colspan]="isAdmin() ? 6 : 5" class="px-6 py-24 text-center">
                            <div class="flex flex-col items-center gap-4">
                                <div
                                    class="w-16 h-16 rounded-2xl bg-white/[0.02] border border-white/[0.06] flex items-center justify-center">
                                    <iconify-icon icon="lucide:inbox" width="28"
                                        class="text-neutral-700"></iconify-icon>
                                </div>
                                <div class="space-y-1">
                                    <p class="task-display-font text-sm font-medium text-neutral-400">Sin tareas
                                        encontradas</p>
                                    <p class="text-[12px] text-neutral-600 max-w-[280px] mx-auto leading-relaxed">
                                        @if (activeFilter() !== 'todas') {
                                        No hay tareas con el filtro seleccionado. Prueba con otro estado.
                                        } @else if (isAdmin()) {
                                        Crea tu primera tarea usando el botón superior.
                                        } @else {
                                        No tienes tareas asignadas en este momento.
                                        }
                                    </p>
                                </div>
                            </div>
                        </td>
                    </tr>
                    }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ════════════════ TOASTER ════════════════ -->
<hlm-toaster />


<!-- ════════════════════════════════════════════════════════════════
     MODAL: CREAR TAREA (Admin)
     ════════════════════════════════════════════════════════════════ -->
@if (showCreateModal()) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 task-modal-backdrop"
    (click)="closeCreateModal()">
    <div class="task-modal-content bg-[#0c0d14] border border-white/[0.08] rounded-2xl w-full max-w-lg shadow-2xl shadow-black/50"
        (click)="$event.stopPropagation()">

        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-5 border-b border-white/[0.06]">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                    <iconify-icon icon="lucide:plus-circle" width="18"></iconify-icon>
                </div>
                <div>
                    <h3 class="task-display-font text-base font-semibold text-white">Nueva Tarea</h3>
                    <p class="text-[11px] text-neutral-600">Crea y asigna una tarea a un trabajador</p>
                </div>
            </div>
            <button (click)="closeCreateModal()"
                class="text-neutral-600 hover:text-white transition-colors p-2 hover:bg-white/[0.04] rounded-lg">
                <iconify-icon icon="lucide:x" width="18"></iconify-icon>
            </button>
        </div>

        <!-- Body -->
        <div class="px-6 py-5 space-y-5 max-h-[65vh] overflow-y-auto task-scrollbar">
            <!-- Nombre -->
            <div class="space-y-1.5">
                <label class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-500">Nombre *</label>
                <input type="text" [ngModel]="newTask().nombre" (ngModelChange)="updateTaskNombre($event)"
                    placeholder="Ej: Diseño de landing page"
                    class="w-full px-4 py-2.5 bg-white/[0.03] border border-white/[0.08] rounded-xl text-sm text-neutral-200 placeholder:text-neutral-700 focus:ring-1 focus:ring-indigo-500/30 focus:border-indigo-500/30 transition-all outline-none" />
            </div>

            <!-- Descripción -->
            <div class="space-y-1.5">
                <label class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-500">Descripción *</label>
                <textarea [ngModel]="newTask().descripcion" (ngModelChange)="updateTaskDescripcion($event)"
                    placeholder="Detalla los requisitos y entregables..." rows="3"
                    class="w-full px-4 py-2.5 bg-white/[0.03] border border-white/[0.08] rounded-xl text-sm text-neutral-200 placeholder:text-neutral-700 focus:ring-1 focus:ring-indigo-500/30 focus:border-indigo-500/30 transition-all outline-none resize-none"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- Asignar trabajador -->
                <div class="space-y-1.5">
                    <label class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-500">Asignar a
                        *</label>
                    <brn-select class="inline-block w-full" placeholder="Seleccionar..."
                        (valueChange)="onWorkerSelect($event)">
                        <hlm-select-trigger
                            class="w-full bg-white/[0.03] border-white/[0.08] rounded-xl text-sm text-neutral-300">
                            <hlm-select-value />
                        </hlm-select-trigger>
                        <hlm-select-content class="border-white/10">
                            @for (worker of workers(); track worker.id_trabajador) {
                            <hlm-option [value]="worker.id_trabajador">{{ worker.nombres }} {{ worker.apellidos
                                }}</hlm-option>
                            }
                        </hlm-select-content>
                    </brn-select>
                </div>

                <!-- Prioridad -->
                <div class="space-y-1.5">
                    <label class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-500">Prioridad</label>
                    <brn-select class="inline-block w-full" placeholder="Seleccionar..."
                        (valueChange)="onPrioritySelect($event)">
                        <hlm-select-trigger
                            class="w-full bg-white/[0.03] border-white/[0.08] rounded-xl text-sm text-neutral-300">
                            <hlm-select-value />
                        </hlm-select-trigger>
                        <hlm-select-content class="border-white/10">
                            <hlm-option value="alta">
                                <span class="flex items-center gap-2">
                                    <iconify-icon icon="lucide:arrow-up" class="text-red-400" width="13"></iconify-icon>
                                    Alta
                                </span>
                            </hlm-option>
                            <hlm-option value="media">
                                <span class="flex items-center gap-2">
                                    <iconify-icon icon="lucide:minus" class="text-amber-400" width="13"></iconify-icon>
                                    Media
                                </span>
                            </hlm-option>
                            <hlm-option value="baja">
                                <span class="flex items-center gap-2">
                                    <iconify-icon icon="lucide:arrow-down" class="text-emerald-400"
                                        width="13"></iconify-icon>
                                    Baja
                                </span>
                            </hlm-option>
                        </hlm-select-content>
                    </brn-select>
                </div>
            </div>

            <!-- Fecha límite -->
            <div class="space-y-1.5">
                <label class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-500">Fecha Límite <span
                        class="text-neutral-700 normal-case tracking-normal">(opcional)</span></label>
                <input type="date" [ngModel]="newTask().fecha_limite" (ngModelChange)="updateTaskFechaLimite($event)"
                    class="w-full px-4 py-2.5 bg-white/[0.03] border border-white/[0.08] rounded-xl text-sm text-neutral-300 focus:ring-1 focus:ring-indigo-500/30 focus:border-indigo-500/30 transition-all outline-none" />
            </div>
        </div>

        <!-- Footer -->
        <div class="px-6 py-4 border-t border-white/[0.06] flex items-center justify-end gap-3">
            <button (click)="closeCreateModal()"
                class="px-4 py-2 text-sm font-medium text-neutral-500 hover:text-neutral-300 transition-colors">
                Cancelar
            </button>
            <button (click)="submitTask()" [disabled]="isCreating()"
                class="task-action-btn px-5 py-2.5 bg-indigo-600 hover:bg-indigo-500 disabled:bg-neutral-800 disabled:text-neutral-600 text-white rounded-xl font-semibold text-sm shadow-lg shadow-indigo-600/15 transition-all flex items-center gap-2">
                @if (isCreating()) {
                <iconify-icon icon="lucide:loader-2" class="animate-spin" width="15"></iconify-icon>
                Creando...
                } @else {
                <iconify-icon icon="lucide:send" width="15"></iconify-icon>
                Crear Tarea
                }
            </button>
        </div>
    </div>
</div>
}


<!-- ════════════════════════════════════════════════════════════════
     MODAL: RECHAZAR TAREA (Admin)
     ════════════════════════════════════════════════════════════════ -->
@if (showRejectModal()) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 task-modal-backdrop"
    (click)="closeRejectModal()">
    <div class="task-modal-content bg-[#0c0d14] border border-white/[0.08] rounded-2xl w-full max-w-md shadow-2xl shadow-black/50"
        (click)="$event.stopPropagation()">

        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-5 border-b border-white/[0.06]">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 rounded-xl bg-red-500/10 flex items-center justify-center text-red-400">
                    <iconify-icon icon="lucide:alert-triangle" width="18"></iconify-icon>
                </div>
                <h3 class="task-display-font text-base font-semibold text-white">Rechazar Tarea</h3>
            </div>
            <button (click)="closeRejectModal()"
                class="text-neutral-600 hover:text-white transition-colors p-2 hover:bg-white/[0.04] rounded-lg">
                <iconify-icon icon="lucide:x" width="18"></iconify-icon>
            </button>
        </div>

        <!-- Body -->
        <div class="px-6 py-5 space-y-4">
            <p class="text-[13px] text-neutral-400 leading-relaxed">
                Indica el motivo del rechazo. El trabajador recibirá esta observación.
            </p>
            <div class="space-y-1.5">
                <label class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-500">Observación</label>
                <textarea [ngModel]="rejectObservation()" (ngModelChange)="rejectObservation.set($event)"
                    placeholder="Escribe el motivo del rechazo..." rows="4"
                    class="w-full px-4 py-2.5 bg-white/[0.03] border border-white/[0.08] rounded-xl text-sm text-neutral-200 placeholder:text-neutral-700 focus:ring-1 focus:ring-red-500/30 focus:border-red-500/30 transition-all outline-none resize-none"></textarea>
            </div>
        </div>

        <!-- Footer -->
        <div class="px-6 py-4 border-t border-white/[0.06] flex items-center justify-end gap-3">
            <button (click)="closeRejectModal()"
                class="px-4 py-2 text-sm font-medium text-neutral-500 hover:text-neutral-300 transition-colors">
                Cancelar
            </button>
            <button (click)="submitReject()"
                class="task-action-btn px-5 py-2.5 bg-red-600 hover:bg-red-500 text-white rounded-xl font-semibold text-sm shadow-lg shadow-red-600/15 transition-all flex items-center gap-2">
                <iconify-icon icon="lucide:x-circle" width="15"></iconify-icon>
                Rechazar
            </button>
        </div>
    </div>
</div>
}


<!-- ════════════════════════════════════════════════════════════════
     MODAL: DETALLE DE TAREA
     ════════════════════════════════════════════════════════════════ -->
@if (showDetailModal() && selectedTask()) {
<div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 task-modal-backdrop"
    (click)="closeDetailModal()">
    <div class="task-modal-content bg-[#0c0d14] border border-white/[0.08] rounded-2xl w-full max-w-lg shadow-2xl shadow-black/50"
        (click)="$event.stopPropagation()">

        <!-- Header con status bar decorativa -->
        <div class="relative">
            <!-- Top gradient bar -->
            <div [class]="'h-1 w-full rounded-t-2xl ' +
        (selectedTask()!.estado === 'pendiente' ? 'bg-gradient-to-r from-amber-500/60 to-amber-500/10' :
         selectedTask()!.estado === 'en_progreso' ? 'bg-gradient-to-r from-blue-500/60 to-blue-500/10' :
         selectedTask()!.estado === 'subido' ? 'bg-gradient-to-r from-purple-500/60 to-purple-500/10' :
         selectedTask()!.estado === 'aprobado' ? 'bg-gradient-to-r from-emerald-500/60 to-emerald-500/10' :
         'bg-gradient-to-r from-red-500/60 to-red-500/10')"></div>

            <div class="flex items-center justify-between px-6 py-5 border-b border-white/[0.06]">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-xl bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                        <iconify-icon icon="lucide:file-text" width="18"></iconify-icon>
                    </div>
                    <h3 class="task-display-font text-base font-semibold text-white">Detalle</h3>
                </div>
                <button (click)="closeDetailModal()"
                    class="text-neutral-600 hover:text-white transition-colors p-2 hover:bg-white/[0.04] rounded-lg">
                    <iconify-icon icon="lucide:x" width="18"></iconify-icon>
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="px-6 py-5 space-y-5 max-h-[65vh] overflow-y-auto task-scrollbar">

            <!-- Título y descripción -->
            <div class="space-y-3">
                <div class="flex items-start justify-between gap-3">
                    <h4 class="task-display-font text-lg font-bold text-white leading-snug">{{ selectedTask()!.nombre }}
                    </h4>
                    <span [class]="'shrink-0 inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider ' +
            (selectedTask()!.estado === 'pendiente' ? 'bg-amber-500/8 text-amber-400 border border-amber-500/15' :
             selectedTask()!.estado === 'en_progreso' ? 'bg-blue-500/8 text-blue-400 border border-blue-500/15' :
             selectedTask()!.estado === 'subido' ? 'bg-purple-500/8 text-purple-400 border border-purple-500/15' :
             selectedTask()!.estado === 'aprobado' ? 'bg-emerald-500/8 text-emerald-400 border border-emerald-500/15' :
             'bg-red-500/8 text-red-400 border border-red-500/15')">
                        {{ getStatusLabel(selectedTask()!.estado) }}
                    </span>
                </div>
                <p class="text-[13px] text-neutral-400 leading-relaxed">{{ selectedTask()!.descripcion }}</p>
            </div>

            <!-- Info Grid -->
            <div class="grid grid-cols-2 gap-3">
                <!-- Asignado -->
                <div class="p-4 bg-white/[0.02] border border-white/[0.05] rounded-xl">
                    <p class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600 mb-2">Asignado a</p>
                    <div class="flex items-center gap-2">
                        <div
                            class="w-6 h-6 rounded-md bg-gradient-to-br from-indigo-500/80 to-violet-600/80 flex items-center justify-center text-white text-[9px] font-bold">
                            {{ selectedTask()!.trabajador?.nombres?.charAt(0) }}{{
                            selectedTask()!.trabajador?.apellidos?.charAt(0) }}
                        </div>
                        <span class="text-[12px] text-neutral-300 font-medium">{{ selectedTask()!.trabajador?.nombres }}
                            {{ selectedTask()!.trabajador?.apellidos }}</span>
                    </div>
                </div>

                <!-- Prioridad -->
                <div class="p-4 bg-white/[0.02] border border-white/[0.05] rounded-xl">
                    <p class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600 mb-2">Prioridad</p>
                    <span
                        [class]="'inline-flex items-center gap-1.5 text-[12px] font-semibold ' +
            (selectedTask()!.prioridad === 'alta' ? 'text-red-400' : selectedTask()!.prioridad === 'media' ? 'text-amber-400' : 'text-emerald-400')">
                        <iconify-icon [icon]="getPriorityIcon(selectedTask()!.prioridad)" width="14"></iconify-icon>
                        {{ getPriorityLabel(selectedTask()!.prioridad) }}
                    </span>
                </div>

                <!-- Fecha Límite -->
                <div class="p-4 bg-white/[0.02] border border-white/[0.05] rounded-xl">
                    <p class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600 mb-2">Fecha Límite</p>
                    <span class="text-[12px] text-neutral-300">
                        @if (selectedTask()!.fecha_limite) {
                        {{ selectedTask()!.fecha_limite | date:'dd MMM yyyy' }}
                        } @else {
                        <span class="text-neutral-600 italic">Sin fecha</span>
                        }
                    </span>
                </div>

                <!-- Fecha Creación -->
                <div class="p-4 bg-white/[0.02] border border-white/[0.05] rounded-xl">
                    <p class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600 mb-2">Creada</p>
                    <span class="text-[12px] text-neutral-300">
                        @if (selectedTask()!.fecha_creacion) {
                        {{ selectedTask()!.fecha_creacion | date:'dd MMM yyyy' }}
                        } @else {
                        <span class="text-neutral-600">—</span>
                        }
                    </span>
                </div>
            </div>

            <!-- Observación del rechazo -->
            @if (selectedTask()!.observacion) {
            <div class="p-4 bg-red-500/[0.04] border border-red-500/10 rounded-xl">
                <p
                    class="text-[10px] font-bold uppercase tracking-[0.15em] text-red-400/70 mb-2 flex items-center gap-1.5">
                    <iconify-icon icon="lucide:alert-triangle" width="12"></iconify-icon>
                    Observación del rechazo
                </p>
                <p class="text-[13px] text-neutral-300 leading-relaxed">{{ selectedTask()!.observacion }}</p>
            </div>
            }

            <!-- Archivos adjuntos -->
            @if (selectedTask()!.archivos && selectedTask()!.archivos.length > 0) {
            <div class="space-y-2">
                <p class="text-[10px] font-bold uppercase tracking-[0.15em] text-neutral-600">Archivos Adjuntos</p>
                @for (archivo of selectedTask()!.archivos; track archivo.id_archivo_cliente) {
                <a [href]="archivo.ruta" target="_blank"
                    class="flex items-center gap-3 p-3 bg-white/[0.02] border border-white/[0.05] rounded-xl hover:border-indigo-500/20 hover:bg-indigo-500/[0.03] transition-all group">
                    <div class="w-8 h-8 rounded-lg bg-indigo-500/10 flex items-center justify-center text-indigo-400">
                        <iconify-icon icon="lucide:file" width="15"></iconify-icon>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[12px] text-neutral-300 group-hover:text-indigo-400 transition-colors truncate">
                            Archivo #{{ archivo.id_archivo_cliente }}</p>
                        <p class="text-[10px] text-neutral-600">{{ archivo.fecha_subida | date:'dd/MM/yyyy HH:mm' }}</p>
                    </div>
                    <iconify-icon icon="lucide:external-link" width="13"
                        class="text-neutral-700 group-hover:text-indigo-400 transition-colors shrink-0"></iconify-icon>
                </a>
                }
            </div>
            }
        </div>

        <!-- Footer -->
        <div class="px-6 py-4 border-t border-white/[0.06] flex items-center justify-between">
            <div class="flex items-center gap-2">
                @if (isAdmin() && selectedTask()!.estado === 'subido') {
                <button (click)="approveTask(selectedTask()!.id_cliente_tarea); closeDetailModal()"
                    class="task-action-btn px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-semibold text-[12px] transition-all flex items-center gap-1.5">
                    <iconify-icon icon="lucide:check" width="14"></iconify-icon>
                    Aprobar
                </button>
                <button (click)="closeDetailModal(); openRejectModal(selectedTask()!.id_cliente_tarea)"
                    class="task-action-btn px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-semibold text-[12px] transition-all flex items-center gap-1.5">
                    <iconify-icon icon="lucide:x" width="14"></iconify-icon>
                    Rechazar
                </button>
                }
                @if (!isAdmin() && (selectedTask()!.estado === 'pendiente' || selectedTask()!.estado === 'en_progreso'))
                {
                <button (click)="markAsUploaded(selectedTask()!.id_cliente_tarea); closeDetailModal()"
                    class="task-action-btn px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold text-[12px] transition-all flex items-center gap-1.5">
                    <iconify-icon icon="lucide:upload-cloud" width="14"></iconify-icon>
                    Marcar como Subida
                </button>
                }
            </div>
            <button (click)="closeDetailModal()"
                class="px-4 py-2 text-sm font-medium text-neutral-500 hover:text-neutral-300 transition-colors">
                Cerrar
            </button>
        </div>
    </div>
</div>
}